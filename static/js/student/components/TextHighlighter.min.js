window.TextHighlighter={colors:[{name:"Yellow",class:"bg-yellow-200",hex:"#fef08a"},{name:"Green",class:"bg-green-200",hex:"#bbf7d0"},{name:"Pink",class:"bg-pink-200",hex:"#fbcfe8"},{name:"Blue",class:"bg-blue-200",hex:"#bfdbfe"},{name:"Purple",class:"bg-purple-200",hex:"#e9d5ff"}],formats:[{name:"Bold",class:"font-bold",icon:"B"},{name:"Underline",class:"underline",icon:"U"}],highlights:{},currentSection:null,attemptId:null,popupElement:null,containerElement:null,textNodeCache:null,cacheTimestamp:0,CACHE_DURATION:5e3,selectionTimeout:null,saveTimeout:null,boundHandlers:{mouseup:null,keyup:null,mousedown:null},init(t,e,i=null){console.log("[TextHighlighter] Initializing:",t,e),this.cleanup(),this.currentSection=t,this.containerElement=e,this.attemptId=i||window.attemptId||"default",this.textNodeCache=null,this.cacheTimestamp=0,this.loadHighlights(),this.createPopup(),this.setupSelectionListener(e),requestAnimationFrame(()=>{setTimeout(()=>{this.restoreHighlights(e)},100)}),console.log("[TextHighlighter] Initialized successfully")},createPopup(){if(this.popupElement)return;const t=document.createElement("div");t.id="text-highlighter-popup",t.className="fixed hidden z-50 bg-white rounded-lg shadow-xl border border-slate-200 p-2",t.style.cssText="transition: opacity 0.2s ease; will-change: transform;",t.innerHTML=`\n            <div class="flex items-center gap-2 flex-wrap">\n                <div class="text-xs font-semibold text-slate-600 px-2">Highlight:</div>\n                ${this.colors.map((t,e)=>`\n                    <button\n                        type="button"\n                        data-color-index="${e}"\n                        class="w-8 h-8 rounded-md ${t.class} border-2 border-slate-300 hover:border-slate-500 transition-all hover:scale-110 flex items-center justify-center group"\n                        title="${t.name}"\n                    >\n                        <span class="text-xs opacity-0 group-hover:opacity-100 font-bold text-slate-700">✓</span>\n                    </button>\n                `).join("")}\n                <div class="w-px h-6 bg-slate-300 mx-1"></div>\n                <div class="text-xs font-semibold text-slate-600 px-2">Format:</div>\n                ${this.formats.map((t,e)=>`\n                    <button\n                        type="button"\n                        data-format-index="${e}"\n                        class="w-8 h-8 rounded-md bg-slate-100 border-2 border-slate-300 hover:border-indigo-400 hover:bg-indigo-50 transition-all hover:scale-110 flex items-center justify-center group ${t.class}"\n                        title="${t.name}"\n                    >\n                        <span class="text-xs font-bold text-slate-700 group-hover:text-indigo-600">${t.icon}</span>\n                    </button>\n                `).join("")}\n                <div class="w-px h-6 bg-slate-300 mx-1"></div>\n                <button\n                    type="button"\n                    data-action="remove"\n                    class="w-8 h-8 rounded-md bg-slate-100 border-2 border-slate-300 hover:border-red-400 hover:bg-red-50 transition-all hover:scale-110 flex items-center justify-center group"\n                    title="Remove highlight"\n                >\n                    <span class="text-slate-600 group-hover:text-red-600 font-bold">✕</span>\n                </button>\n            </div>\n        `,document.body.appendChild(t),this.popupElement=t,t.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation();const e=t.target.closest("[data-color-index]"),i=t.target.closest("[data-format-index]"),s=t.target.closest('[data-action="remove"]');if(e){const t=parseInt(e.dataset.colorIndex);this.applyHighlight(t,null)}else if(i){const t=parseInt(i.dataset.formatIndex);this.applyFormat(t)}else s&&this.removeHighlight()},!1)},setupSelectionListener(t){const e=()=>{this.selectionTimeout&&clearTimeout(this.selectionTimeout),this.selectionTimeout=setTimeout(()=>{const e=window.getSelection();if(e.toString().trim().length>0&&e.rangeCount>0){const i=e.getRangeAt(0).commonAncestorContainer;i===t||t.contains(i)?this.showPopup(e):this.hidePopup()}else this.hidePopup()},150)};this.boundHandlers.mouseup=e,this.boundHandlers.keyup=e,document.addEventListener("mouseup",this.boundHandlers.mouseup,{passive:!0}),document.addEventListener("keyup",this.boundHandlers.keyup,{passive:!0}),this.boundHandlers.mousedown=t=>{if(this.popupElement&&!this.popupElement.contains(t.target)){window.getSelection().toString().trim()||this.hidePopup()}},document.addEventListener("mousedown",this.boundHandlers.mousedown,{passive:!0})},showPopup(t){if(!this.popupElement||0===t.rangeCount)return;const e=t.getRangeAt(0).getBoundingClientRect();let i=e.left+e.width/2-200,s=e.top-50-10;i=Math.max(10,Math.min(i,window.innerWidth-400-10)),s<10&&(s=e.bottom+10),this.popupElement.style.transform=`translate(${i}px, ${s}px)`,this.popupElement.style.left="0",this.popupElement.style.top="0",this.popupElement.classList.remove("hidden"),this.popupElement.style.opacity="1"},hidePopup(){this.popupElement&&!this.popupElement.classList.contains("hidden")&&(this.popupElement.style.opacity="0",setTimeout(()=>{this.popupElement&&this.popupElement.classList.add("hidden")},200))},applyHighlight(t,e=null){const i=window.getSelection();if(0===i.rangeCount)return;const s=i.getRangeAt(0),n=i.toString().trim();if(!n)return;const o=this.colors[t],h=s.commonAncestorContainer;let l=3===h.nodeType?h.parentElement:h;if("MARK"===l.tagName&&l.dataset.highlightSection===this.currentSection){l.className=`${o.class} rounded px-0.5 transition-colors cursor-pointer`;return(l.dataset.highlightFormats?l.dataset.highlightFormats.split(",").map(t=>parseInt(t)):[]).forEach(t=>{l.classList.add(this.formats[t].class)}),l.dataset.highlightColor=t,i.removeAllRanges(),this.hidePopup(),void this.saveAllHighlights()}try{const h=document.createElement("mark");h.className=`${o.class} rounded px-0.5 transition-colors cursor-pointer`,h.dataset.highlightColor=t,h.dataset.highlightSection=this.currentSection,h.dataset.highlightAttempt=this.attemptId,e&&e.length>0&&(h.dataset.highlightFormats=e.join(","),e.forEach(t=>{h.classList.add(this.formats[t].class)})),s.surroundContents(h);const l=e||[];this.saveHighlight(n,t,l),i.removeAllRanges(),this.hidePopup()}catch(i){console.log("Using advanced highlight method for complex selection"),this.applyHighlightAdvanced(s,n,t,e)}},applyHighlightAdvanced(t,e,i,s=null){const n=this.colors[i],o=this.getTextNodesInRange(t);if(0===o.length)return void this.hidePopup();o.forEach(t=>{try{const e=document.createElement("mark");e.className=`${n.class} rounded px-0.5 transition-colors cursor-pointer`,e.dataset.highlightColor=i,e.dataset.highlightSection=this.currentSection,e.dataset.highlightAttempt=this.attemptId,s&&s.length>0&&(e.dataset.highlightFormats=s.join(","),s.forEach(t=>{this.formats[t]&&e.classList.add(this.formats[t].class)}));t.parentNode.insertBefore(e,t),e.appendChild(t)}catch(t){console.warn("Failed to highlight text node:",t)}});const h=s||[];this.saveHighlight(e,i,h),window.getSelection().removeAllRanges(),this.hidePopup()},getTextNodesInRange(t){const e=[],i=document.createTreeWalker(t.commonAncestorContainer,NodeFilter.SHOW_TEXT,{acceptNode:e=>{const i=document.createRange();return i.selectNodeContents(e),t.compareBoundaryPoints(Range.END_TO_START,i)<=0&&t.compareBoundaryPoints(Range.START_TO_END,i)>=0?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT}});let s;for(;s=i.nextNode();)if(s.textContent.trim().length>0){let t=s.parentElement,i=!1;for(;t;){if("MARK"===t.tagName&&t.dataset.highlightAttempt===this.attemptId){i=!0;break}t=t.parentElement}i||e.push(s)}return e},applyFormat(t){const e=window.getSelection();if(0===e.rangeCount)return;const i=e.getRangeAt(0);if(!e.toString().trim())return;const s=this.formats[t],n=i.commonAncestorContainer;let o=3===n.nodeType?n.parentElement:n;if("MARK"===o.tagName&&o.dataset.highlightSection===this.currentSection){const i=o.dataset.highlightFormats?o.dataset.highlightFormats.split(",").map(t=>parseInt(t)):[];if(i.includes(t)){o.classList.remove(s.class);const e=i.filter(e=>e!==t);o.dataset.highlightFormats=e.join(",")}else o.classList.add(s.class),i.push(t),o.dataset.highlightFormats=i.join(",");e.removeAllRanges(),this.hidePopup(),this.saveAllHighlights()}else this.applyHighlight(0,[t])},removeHighlight(){const t=window.getSelection();if(0===t.rangeCount)return;const e=t.getRangeAt(0).commonAncestorContainer;let i=3===e.nodeType?e.parentElement:e;if("MARK"===i.tagName&&i.dataset.highlightSection===this.currentSection){const e=i.parentNode;for(;i.firstChild;)e.insertBefore(i.firstChild,i);e.removeChild(i),t.removeAllRanges(),this.hidePopup(),this.saveAllHighlights()}},saveHighlight(t,e,i){this.highlights[this.attemptId]||(this.highlights[this.attemptId]={}),this.highlights[this.attemptId][this.currentSection]||(this.highlights[this.attemptId][this.currentSection]=[]),this.highlights[this.attemptId][this.currentSection].push({text:t,color:e,formats:i||[],timestamp:Date.now()}),this.persistHighlights()},saveAllHighlights(){this.saveTimeout&&clearTimeout(this.saveTimeout),this.saveTimeout=setTimeout(()=>{const t=document.querySelectorAll(`mark[data-highlight-section="${this.currentSection}"][data-highlight-attempt="${this.attemptId}"]`);this.highlights[this.attemptId]||(this.highlights[this.attemptId]={}),this.highlights[this.attemptId][this.currentSection]=Array.from(t).map(t=>({text:t.textContent,color:parseInt(t.dataset.highlightColor),formats:t.dataset.highlightFormats?t.dataset.highlightFormats.split(",").map(t=>parseInt(t)):[],timestamp:Date.now()})),this.persistHighlights()},300)},restoreHighlights(t){const e=this.highlights[this.attemptId];if(!e)return;const i=e[this.currentSection];if(!i||0===i.length)return;console.log("[TextHighlighter] Restoring",i.length,"highlights"),this.clearVisualHighlights();const s=e=>{let n=0;const o=()=>{const h=Math.min(n+5,i.length);for(let e=n;e<h;e++){const s=i[e];this.findAndHighlightText(t,s.text,s.color,s.formats||[])}n=h,n<i.length&&(e&&e.timeRemaining()>0?o():requestAnimationFrame(()=>{"requestIdleCallback"in window?requestIdleCallback(s,{timeout:1e3}):setTimeout(()=>s({}),50)}))};o()};"requestIdleCallback"in window?requestIdleCallback(s,{timeout:1e3}):setTimeout(()=>s({}),100)},findAndHighlightText(t,e,i,s=[]){const n=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,null,!1),o=this.colors[i];let h;const l=[];for(;h=n.nextNode();){const t=h.textContent.indexOf(e);-1!==t&&l.push({node:h,index:t,length:e.length})}if(l.length>0){const{node:t,index:e,length:n}=l[0];try{const h=document.createRange();h.setStart(t,e),h.setEnd(t,e+n);const l=document.createElement("mark");l.className=`${o.class} rounded px-0.5 transition-colors cursor-pointer`,l.dataset.highlightColor=i,l.dataset.highlightSection=this.currentSection,l.dataset.highlightAttempt=this.attemptId,s.length>0&&(l.dataset.highlightFormats=s.join(","),s.forEach(t=>{this.formats[t]&&l.classList.add(this.formats[t].class)})),h.surroundContents(l)}catch(t){console.warn("Could not restore highlight:",t)}}},loadHighlights(){try{const t=localStorage.getItem("text-highlights");t&&(this.highlights=JSON.parse(t))}catch(t){console.warn("Could not load highlights:",t),this.highlights={}}},persistHighlights(){try{localStorage.setItem("text-highlights",JSON.stringify(this.highlights))}catch(t){console.warn("Could not save highlights:",t)}},clearVisualHighlights(){document.querySelectorAll(`mark[data-highlight-section="${this.currentSection}"][data-highlight-attempt="${this.attemptId}"]`).forEach(t=>{const e=t.parentNode;if(e){for(;t.firstChild;)e.insertBefore(t.firstChild,t);e.removeChild(t),e.normalize()}}),this.textNodeCache=null},clearSectionHighlights(){this.clearVisualHighlights(),this.highlights[this.attemptId]&&(delete this.highlights[this.attemptId][this.currentSection],this.persistHighlights())},clearAttemptHighlights(){document.querySelectorAll(`mark[data-highlight-attempt="${this.attemptId}"]`).forEach(t=>{const e=t.parentNode;if(e){for(;t.firstChild;)e.insertBefore(t.firstChild,t);e.removeChild(t)}}),this.highlights[this.attemptId]&&(delete this.highlights[this.attemptId],this.persistHighlights())},clearAllHighlights(){document.querySelectorAll("mark[data-highlight-attempt]").forEach(t=>{const e=t.parentNode;if(e){for(;t.firstChild;)e.insertBefore(t.firstChild,t);e.removeChild(t)}}),this.highlights={},this.persistHighlights()},cleanup(){console.log("[TextHighlighter] Cleaning up"),this.selectionTimeout&&(clearTimeout(this.selectionTimeout),this.selectionTimeout=null),this.saveTimeout&&(clearTimeout(this.saveTimeout),this.saveTimeout=null),this.boundHandlers.mouseup&&document.removeEventListener("mouseup",this.boundHandlers.mouseup),this.boundHandlers.keyup&&document.removeEventListener("keyup",this.boundHandlers.keyup),this.boundHandlers.mousedown&&document.removeEventListener("mousedown",this.boundHandlers.mousedown),this.boundHandlers={mouseup:null,keyup:null,mousedown:null},this.popupElement&&(this.popupElement.remove(),this.popupElement=null),this.textNodeCache=null,this.cacheTimestamp=0,this.containerElement=null}};